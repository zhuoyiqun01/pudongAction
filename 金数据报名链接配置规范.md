# 金数据报名链接配置规范

## 📋 概述

本文档规范了活动报名链接的配置标准，统一使用**金数据小程序跳转**方案。

**字段说明：**
- `register_jsj`：**推荐使用**，专门用于存储金数据小程序路径
- `register_url`：保留字段，用于兼容旧数据或其他类型的报名链接（如 HTTP 链接）
- `register_info`：文本类型的报名信息，显示在弹窗中（如"请联系XXX报名"）

**检查顺序：** `register_jsj` → `register_url` → `register_info`

## 🎯 标准格式

### ✅ 推荐格式（新标准）

**格式：** `pages/forms/publish?token=xxxxx`

**示例：**
```
pages/forms/publish?token=xlSV2U
```

**说明：**
- 这是金数据官方推荐的最新格式
- 支持收集微信用户信息（OpenID、UnionID、微信昵称）
- 无需配置业务域名，无需联系客服
- 只需在小程序后台配置跳转权限

### ⚠️ 兼容格式（旧格式）

**格式：** `pages/form/index?entry=xxxxx`

**说明：**
- 这是旧版格式，代码已兼容支持
- 建议逐步迁移到新格式

## 📝 后台配置步骤

### 1. 获取金数据表单路径

1. 登录 [金数据后台](https://jinshuju.net/)
2. 进入需要嵌入的表单
3. 点击 **发布** 按钮
4. 找到 **"小程序表单路径"** 或 **"小程序路径"**
5. 复制路径（格式：`pages/forms/publish?token=xxxxx`）

### 2. 在 CMS 中配置

在云数据库的 `activities` 集合中，为活动添加 `register_jsj` 字段：

```javascript
{
  // ... 其他字段
  register_jsj: "pages/forms/publish?token=xlSV2U",  // 金数据小程序路径（推荐）
  register_url: "https://example.com/form"            // 其他报名链接（可选，兼容旧数据）
}
```

**字段优先级：**
- 代码会**优先使用** `register_jsj` 字段
- 如果 `register_jsj` 为空，则回退使用 `register_url` 字段（向后兼容）

**重要提示：**
- ✅ 直接使用 `pages/forms/publish?token=xxxxx` 格式
- ✅ 使用 `register_jsj` 字段存储金数据小程序路径
- ❌ 不要添加 `https://` 前缀
- ❌ 不要添加小程序 AppID
- ❌ 不要使用完整的 URL 链接

## 🔧 小程序后台配置

### 配置跳转权限（仅需一次）

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序后台
3. 前往 **设置** → **基本设置** → **小程序跳转小程序**
4. 添加金数据小程序：
   - **AppID**：`wx34b0738d0eef5f78`
   - **账号原始ID**：`gh_fae00bf660be`（可选）

**注意：** 根据微信小程序最新规则，可能不需要在后台配置，代码会直接尝试跳转。如果跳转失败，再按上述步骤配置。

## 💻 代码实现

代码已自动识别并处理金数据小程序路径：

```javascript
// 自动检测金数据小程序路径
if (registerUrl.startsWith('pages/forms/publish') || 
    registerUrl.startsWith('pages/form/index')) {
  // 跳转到金数据小程序
  wx.navigateToMiniProgram({
    appId: 'wx34b0738d0eef5f78',
    path: registerUrl
  });
}
```

## 📊 字段和格式对比

### 字段说明

| 字段名 | 用途 | 推荐度 | 说明 |
|--------|------|--------|------|
| **`register_jsj`** | 金数据小程序路径 | ✅ **推荐** | 专门用于存储金数据小程序路径 |
| `register_url` | 其他报名链接 | ⚠️ 兼容 | 保留字段，用于兼容旧数据或其他类型链接 |

### 路径格式

| 格式类型 | 示例 | 是否推荐 | 说明 |
|---------|------|---------|------|
| **新格式（推荐）** | `pages/forms/publish?token=xlSV2U` | ✅ | 官方最新格式，支持收集微信信息 |
| 旧格式（兼容） | `pages/form/index?entry=xxxxx` | ⚠️ | 旧版格式，已兼容但建议迁移 |
| HTTP/HTTPS 链接 | `https://jinshuju.net/f/xxxxx` | ❌ | 需要配置业务域名，不推荐（可放在 `register_url`） |
| 完整小程序路径 | `wx34b0738d0eef5f78/pages/forms/publish?token=xxxxx` | ❌ | 格式错误，不要包含 AppID |

## ⚠️ 常见错误

### ❌ 错误示例 1：包含协议前缀
```
错误：register_jsj: "https://pages/forms/publish?token=xlSV2U"
正确：register_jsj: "pages/forms/publish?token=xlSV2U"
```

### ❌ 错误示例 2：包含 AppID
```
错误：register_jsj: "wx34b0738d0eef5f78/pages/forms/publish?token=xlSV2U"
正确：register_jsj: "pages/forms/publish?token=xlSV2U"
```

### ❌ 错误示例 3：使用网页链接（应放在 register_url）
```
错误：register_jsj: "https://jinshuju.net/f/xlSV2U"
正确：register_jsj: "pages/forms/publish?token=xlSV2U"
      register_url: "https://jinshuju.net/f/xlSV2U"  // 如果需要保留网页链接
```

### ✅ 正确示例：字段分离
```javascript
{
  // 金数据小程序路径（推荐）
  register_jsj: "pages/forms/publish?token=xlSV2U",
  
  // 其他类型的报名链接（可选，兼容旧数据）
  register_url: "https://example.com/other-form"  // 或留空
}
```

## ✅ 验证方法

配置完成后，在活动详情页点击"立即报名"按钮：

1. **成功情况**：会弹出"即将打开 金数据 小程序"提示，点击"允许"后跳转到金数据表单
2. **失败情况**：会提示"无法跳转到金数据小程序"，并提供复制链接选项

## 🔄 字段优先级逻辑

代码会按以下顺序检查报名信息：

### 检查顺序

1. **优先检查** `register_jsj` 字段
   - 如果有值且为金数据小程序路径，直接跳转到金数据小程序
   - 按钮文字：**"立即报名"**

2. **回退检查** `register_url` 字段（向后兼容）
   - 如果 `register_jsj` 为空，检查 `register_url`
   - 如果是金数据小程序路径，跳转到金数据小程序
   - 如果是 HTTP/HTTPS 链接，使用 web-view 打开
   - 按钮文字：**"立即报名"**

3. **最后检查** `register_info` 字段
   - 如果前两个字段都为空，检查 `register_info`
   - 如果有值，点击按钮显示"报名方式"弹窗（显示文本信息）
   - 按钮文字：**"报名方式"**

### 按钮文字规则

| 字段情况 | 按钮文字 |
|---------|---------|
| 有 `register_jsj` 或 `register_url` | **"立即报名"** |
| 只有 `register_info` | **"报名方式"** |
| 三个字段都没有 | **"报名方式"**（点击后提示"暂无报名信息"） |

## 🔗 参考文档

- [金数据官方文档 - 表单嵌入自研微信小程序](https://nexthelp.jinshuju.net/articles/mini-3rd)
- [金数据表单嵌入配置说明](./金数据表单嵌入配置说明.md)

## 📞 技术支持

如果遇到问题：

1. **检查路径格式**：确保使用 `pages/forms/publish?token=xxxxx` 格式
2. **检查小程序配置**：确认已在小程序后台配置跳转权限
3. **查看控制台日志**：检查是否有错误信息
4. **联系开发人员**：提供具体的错误信息和表单路径

---

**最后更新：** 2025-01-XX  
**维护者：** 开发团队

