# 金数据表单嵌入小程序 - 完整配置方案

## 📋 方案概览

根据[金数据官方文档](https://nexthelp.jinshuju.net/articles/mini-3rd)，小程序嵌入金数据表单有三种可行方案，请根据你的实际情况选择：

| 方案 | 适用场景 | 成本 | 难度 | 推荐度 |
|------|---------|------|------|--------|
| **方案一：web-view + 二级域名** | 企业基础版及以上套餐 | 4,399元/年起 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **方案二：web-view + jinshuju.net** | 不需要收集微信信息 | 免费版可用 | ⭐⭐ | ⭐⭐⭐⭐ |
| **方案三：跳转金数据小程序** | 需要收集微信信息 | 免费版可用 | ⭐⭐⭐ | ⭐⭐⭐ |

---

## 🎯 方案一：使用 web-view + 金数据二级域名（推荐）

### 适用条件
- ✅ 已购买**企业基础版及以上套餐**（4,399元/年）
- ✅ 需要在小程序中直接嵌入表单
- ✅ 不需要收集微信用户信息（OpenID、UnionID等）

### 实施步骤

#### 1. 联系金数据客服配置二级域名

1. **联系客服**：
   - 在线客服：登录金数据后台，点击"在线客服"
   - 电话客服：400-800-6886
   - 说明需求：需要在小程序中嵌入表单，申请配置独立的二级域名

2. **提供信息**：
   - 告诉客服你需要的二级域名前缀（例如：`xiaojin`）
   - 配置完成后，表单域名将从 `https://jinshuju.com` 变更为 `https://xiaojin.jinshuju.com`

3. **等待配置完成**：
   - 客服会在后台为你配置二级域名
   - 通常1-2个工作日完成

#### 2. 配置小程序业务域名

1. **在小程序后台添加业务域名**：
   - 登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 进入 **开发** → **开发管理** → **开发设置**
   - 找到 **业务域名** 配置项
   - 点击 **添加** 按钮
   - 添加你的二级域名：`xiaojin.jinshuju.com`（替换为你申请的域名）

2. **下载验证文件**：
   - 系统会生成验证文件（如 `MP_verify_abc123.txt`）
   - 点击 **下载** 保存到本地
   - **重要**：不要修改文件内容，保持原样

3. **发送验证文件给金数据客服**：
   - 将下载的验证文件发送给金数据在线客服
   - 说明：这是小程序业务域名验证文件，需要上传到二级域名根目录
   - 客服会帮你上传验证文件

4. **完成验证**：
   - 等待客服确认验证文件已上传
   - 回到小程序后台，点击 **验证** 或 **保存**
   - 系统会自动检查，验证通过后配置完成

#### 3. 配置金数据表单

1. **表单设置**：
   - 进入表单编辑页面
   - **表单设置** → **人群管理** → **填写规则**
   - 开启 **"不收集用户信息"**（重要！）
   - 保存设置

2. **获取表单链接**：
   - 进入表单 **发布** 页面
   - 复制表单链接（格式：`https://xiaojin.jinshuju.com/f/xxxxx`）

#### 4. 更新代码支持新域名

需要更新代码以支持金数据的二级域名格式：

```javascript
// 检测是否为金数据表单
isJinshujuForm(url) {
  try {
    const urlObj = new URL(url);
    // 支持多种金数据域名格式
    return urlObj.hostname === 'jsj.top' 
        || urlObj.hostname.endsWith('.jsj.top')
        || urlObj.hostname.endsWith('.jinshuju.com')
        || urlObj.hostname === 'jinshuju.net';
  } catch (e) {
    return false;
  }
}
```

---

## 🎯 方案二：使用 web-view + jinshuju.net（免费方案）

### 适用条件
- ✅ **不需要收集微信用户信息**
- ✅ 免费版套餐即可使用
- ✅ 需要在小程序中直接嵌入表单

### 实施步骤

#### 1. 配置金数据表单

1. **表单设置**：
   - 进入表单编辑页面
   - **表单设置** → **人群管理** → **填写规则**
   - **开启 "不收集用户信息"**（必须！）
   - 保存设置

2. **获取表单链接**：
   - 表单链接格式：`https://jinshuju.net/f/xxxxx`

#### 2. 配置小程序业务域名

1. **在小程序后台添加业务域名**：
   - 登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 进入 **开发** → **开发管理** → **开发设置**
   - 找到 **业务域名** 配置项
   - 添加域名：`jinshuju.net`

2. **验证文件处理**：
   - 下载验证文件
   - **联系金数据客服**，将验证文件发送给客服
   - 说明：需要将验证文件上传到 `jinshuju.net` 域名根目录
   - 等待客服确认

3. **完成验证**：
   - 在小程序后台点击验证
   - 验证通过后即可使用

#### 3. 更新代码

代码已支持 `jinshuju.net` 域名，无需修改。

---

## 🎯 方案三：跳转金数据小程序（无需配置域名，无需联系客服）

### 适用条件
- ✅ 需要收集微信用户信息（OpenID、UnionID、微信昵称）
- ✅ 免费版套餐即可使用
- ✅ 可以接受跳转到金数据小程序

### ⚠️ 重要说明

**方案三不需要联系金数据客服配置验证文件！**

因为方案三是跳转到金数据自己的小程序，不涉及业务域名配置，所以：
- ❌ **不需要**联系金数据客服
- ❌ **不需要**配置业务域名
- ❌ **不需要**上传验证文件
- ✅ **只需要**在小程序后台配置跳转权限（自己操作即可）

### 实施步骤

#### 1. 配置金数据表单

1. **表单设置**：
   - 进入表单编辑页面
   - **表单设置** → **人群管理** → **填写规则**
   - **开启 "收集用户信息"**
   - 保存设置

2. **获取小程序表单路径**：
   - 进入表单 **发布** 页面
   - 找到 **"小程序表单路径"** 或 **"小程序路径"**
   - 复制路径（格式：`pages/forms/publish?token=xxxxx` 或 `pages/form/index?entry=xxxxx`）
   - **推荐使用新格式**：`pages/forms/publish?token=xxxxx`

#### 2. 配置小程序跳转权限（自己操作，无需联系客服）

**重要更新**：根据微信小程序的最新规则，小程序跳转小程序**可能不需要在后台配置**，或者配置位置已变更。

**方法一：直接使用代码（推荐）**

代码已实现，可以直接使用 `wx.navigateToMiniProgram` API 跳转，**无需后台配置**。

如果跳转时提示需要配置，再尝试方法二。

**方法二：在后台配置（如果需要）**

如果代码跳转失败，提示需要配置权限，可以尝试以下位置：

1. **可能的配置位置**：
   - **设置** → **基本设置** → 查找"小程序跳转"相关选项
   - 或者直接在代码中使用，微信会自动提示配置位置

2. **如果找到配置项**：
   - 添加金数据小程序：
     - **AppID**：`wx34b0738d0eef5f78`
     - **账号原始ID**：`gh_fae00bf660be`（可选）

3. **如果找不到配置项**：
   - 直接使用代码即可，微信小程序基础库 2.0.7+ 支持直接跳转
   - 首次跳转时，微信可能会提示用户授权
   - 用户授权后即可正常跳转

#### 3. 代码已实现（无需修改）

代码已支持方案三，会自动识别以下格式并跳转到金数据小程序：
- `pages/forms/publish?token=xxxxx`（新格式，推荐）
- `pages/form/index?entry=xxxxx`（旧格式，兼容）

---

## 📝 当前代码已实现的功能

小程序已支持以下功能：

1. **自动识别金数据表单**：自动检测多种金数据域名格式
2. **优化显示效果**：
   - 自动隐藏页眉（`banner=hide`）
   - 设置白色背景（`background=white`）
3. **错误处理**：如果表单无法加载，提供复制链接到浏览器的降级方案

---

## 🚀 快速开始 - 选择你的方案

### 如果你有企业基础版套餐（推荐）

**选择方案一**：
1. 联系金数据客服申请二级域名
2. 在小程序后台配置业务域名
3. 将验证文件发送给金数据客服
4. 在表单设置中开启"不收集用户信息"
5. 使用新的二级域名链接

### 如果你只有免费版/专业版

**选择方案二**（不需要收集微信信息）：
1. 在表单设置中开启"不收集用户信息"
2. 在小程序后台配置业务域名 `jinshuju.net`
3. 将验证文件发送给金数据客服
4. 使用 `jinshuju.net` 域名的表单链接

**选择方案三**（需要收集微信信息）：
1. 在表单设置中开启"收集用户信息"
2. 获取表单的小程序路径
3. 在小程序后台配置跳转权限
4. 更新代码支持小程序跳转（见下方代码示例）

---

## 💻 代码实现示例

### 方案三：小程序跳转实现

如果需要实现方案三（跳转金数据小程序），需要在活动详情页添加以下代码：

```javascript
// 在 miniprogram/pages/activity-detail/index.js 的 onJoin 方法中
onJoin() {
  const activity = this.data.activity;
  
  if (activity.register_url && activity.register_url.trim()) {
    let registerUrl = activity.register_url.trim();
    
    // 检测是否为金数据小程序路径
    // 支持格式：
    // - pages/forms/publish?token=xxxxx（新格式，推荐）
    // - pages/form/index?entry=xxxxx（旧格式，兼容）
    if (registerUrl.startsWith('pages/forms/publish') || 
        registerUrl.startsWith('pages/form/index')) {
      // 跳转到金数据小程序
      wx.navigateToMiniProgram({
        appId: 'wx34b0738d0eef5f78', // 金数据小程序 AppID
        path: registerUrl,
        success: () => {
          console.log('跳转到金数据小程序成功');
        },
        fail: (err) => {
          console.error('跳转失败:', err);
          wx.showModal({
            title: '提示',
            content: '无法跳转到金数据小程序，请检查是否已配置跳转权限。',
            showCancel: false
          });
        }
      });
      return;
    }
    
    // 原有的 HTTP 链接处理逻辑
    if (registerUrl.startsWith('http://') || registerUrl.startsWith('https://')) {
      // ... 现有代码保持不变
    }
  }
}
```

---

## ⚠️ 重要注意事项

### 关于验证文件上传

**关键点**：对于金数据的域名（`jinshuju.com`、`jinshuju.net`、`jsj.top`），你**无法直接上传验证文件**，因为这是第三方域名。

**方案一和方案二需要联系客服**：
1. 在小程序后台下载验证文件
2. **将验证文件发送给金数据客服**
3. 客服会帮你上传到域名根目录
4. 等待客服确认后，在小程序后台完成验证

**方案三不需要联系客服**：
- ✅ 方案三（跳转金数据小程序）**不需要**联系客服
- ✅ 方案三**不需要**配置业务域名
- ✅ 方案三**不需要**上传验证文件
- ✅ 只需要在小程序后台自己配置跳转权限即可

**不要尝试**：
- ❌ 自己上传验证文件到金数据域名（你没有权限）
- ❌ 修改验证文件内容（会导致验证失败）

### 关于微信信息收集

根据[金数据官方文档](https://nexthelp.jinshuju.net/articles/mini-3rd)：

- **不需要收集微信信息**：
  - 在表单设置中开启"不收集用户信息"
  - 可以使用 `web-view` 嵌入（方案一或方案二）
  - 表单链接使用 `jinshuju.net` 或二级域名

- **需要收集微信信息**：
  - 在表单设置中开启"收集用户信息"
  - **必须使用方案三**（跳转金数据小程序）
  - 无法在 `web-view` 中收集微信信息（微信限制）

### 关于套餐要求

- **方案一**（二级域名）：需要**企业基础版及以上套餐**（4,399元/年）
- **方案二**（jinshuju.net）：免费版可用
- **方案三**（小程序跳转）：免费版可用

---

## 📞 联系金数据客服

- **在线客服**：登录金数据后台，点击"在线客服"
- **电话客服**：400-800-6886
- **客服时间**：工作日 9:00-18:00

---

## 📚 参考文档

- [金数据 - 表单嵌入自研微信小程序](https://nexthelp.jinshuju.net/articles/mini-3rd)（**重要！官方文档**）
- [金数据开放平台 - 表单嵌入](https://open.jinshuju.net/embedded/overview)
- [微信小程序 - web-view 组件](https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html)
- [微信小程序 - 业务域名配置](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#%E4%B8%9A%E5%8A%A1%E5%9F%9F%E5%90%8D)

## 已实现的功能

1. **自动识别金数据表单**：自动检测 `jsj.top` 域名的表单链接
2. **优化显示效果**：
   - 自动隐藏页眉（`banner=hide`）
   - 设置白色背景（`background=white`），确保在小程序中显示正常
3. **错误处理**：如果表单无法加载，提供复制链接到浏览器的降级方案

## 配置步骤

### 1. 配置小程序业务域名

要在小程序中使用 `web-view` 组件打开金数据表单，需要在微信小程序后台配置业务域名。

#### 配置方法：

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序后台
3. 前往 **开发** → **开发管理** → **开发设置**
4. 找到 **业务域名** 配置项
5. 点击 **添加** 按钮
6. 添加以下域名：
   - `jsj.top`
   - `*.jsj.top`（如果需要支持子域名）

#### 验证文件上传步骤（重要）：

当你在微信小程序后台添加业务域名时，系统会要求你下载一个验证文件（通常是 `MP_verify_xxxxx.txt` 格式），然后上传到域名的根目录。

**详细操作步骤：**

1. **下载验证文件**
   - 在微信小程序后台，点击"添加"业务域名后
   - 系统会生成一个验证文件，文件名类似：`MP_verify_xxxxxxxxxx.txt`
   - 点击"下载"按钮，保存到本地

2. **上传到域名根目录**
   
   **域名根目录**指的是：通过 `https://域名/验证文件名.txt` 可以直接访问到该文件的位置。
   
   例如：如果验证文件是 `MP_verify_abc123.txt`，上传后应该可以通过 `https://jsj.top/MP_verify_abc123.txt` 访问到。

   **上传方法（根据你的服务器类型选择）：**
   
   - **FTP/SFTP 上传**：
     - 使用 FTP 客户端（如 FileZilla、WinSCP）连接到服务器
     - 进入网站根目录（通常是 `public_html`、`www`、`htdocs` 或 `/var/www/html`）
     - 将验证文件上传到根目录
   
   - **服务器 SSH 上传**：
     ```bash
     # 使用 scp 命令上传
     scp MP_verify_abc123.txt user@your-server:/var/www/html/
     
     # 或使用 sftp
     sftp user@your-server
     put MP_verify_abc123.txt /var/www/html/
     ```
   
   - **云服务器控制台上传**：
     - 登录云服务器控制台（如阿里云、腾讯云）
     - 使用文件管理器或上传功能
     - 将文件上传到网站根目录
   
   - **CDN/静态托管服务**：
     - 如果使用 CDN 或静态托管（如 GitHub Pages、Vercel）
     - 将文件上传到项目的根目录
     - 确保可以通过 HTTPS 访问

3. **验证文件可访问性**
   - 上传完成后，在浏览器中访问：`https://jsj.top/MP_verify_abc123.txt`
   - 应该能看到文件内容（通常是几行验证码）
   - 如果无法访问，检查：
     - 文件是否上传到正确的目录
     - 文件名是否正确（区分大小写）
     - 服务器是否支持 HTTPS
     - 是否有权限访问该文件

4. **在微信后台完成验证**
   - 回到微信小程序后台
   - 点击"验证"或"保存"按钮
   - 系统会自动检查验证文件是否可以访问
   - 验证通过后，域名配置完成

#### ⚠️ 重要提示：第三方域名的情况

**对于金数据域名 `jsj.top`：**

这是一个第三方域名，你通常**没有权限**上传验证文件到这个域名的根目录。这种情况下有两种解决方案：

**方案一：联系金数据官方（推荐）**
- 联系金数据客服，询问是否已经为小程序业务域名配置了验证文件
- 或者询问是否可以为你的小程序配置业务域名白名单
- 金数据可能已经为常用的小程序配置了通用验证文件

**方案二：使用降级方案（当前已实现）**
- 如果无法配置业务域名，小程序会提示用户"复制链接到浏览器打开"
- 用户可以在浏览器中正常填写表单
- 这是微信小程序对第三方域名的安全限制

**方案三：使用服务器代理（高级）**
- 在自己的服务器上创建一个代理页面
- 通过 iframe 或反向代理的方式嵌入金数据表单
- 将自己的域名配置为业务域名
- 需要一定的服务器开发能力

#### 注意事项：

- 业务域名需要配置 HTTPS 协议（不支持 HTTP）
- 验证文件必须可以通过 HTTPS 直接访问
- 每个小程序最多可配置 20 个业务域名
- 配置后需要等待审核通过（通常几分钟内）
- 验证文件上传后可以删除，但建议保留以备后续验证

### 2. 在活动数据中添加报名链接

在云数据库的 `activities` 集合中，为活动添加 `register_url` 字段：

```javascript
{
  // ... 其他字段
  register_url: "https://jsj.top/f/xlSV2U"  // 金数据表单链接
}
```

### 3. 金数据表单设置

在金数据表单后台，确保：

1. **表单已发布**：表单必须处于已发布状态
2. **允许嵌入**：确保表单允许在外部网站嵌入
3. **关闭微信收集信息**：如果开启了微信收集信息或微信支付，会导致表单嵌入失效（参考：[金数据文档](https://open.jinshuju.net/embedded/overview)）

## 使用示例

### 活动详情页

当用户在活动详情页点击"立即报名"按钮时：

1. 如果活动有 `register_url` 字段，且为 `https://` 开头的链接
2. 系统会自动跳转到问卷页面（`/pages/questionnaire/index`）
3. 如果是金数据表单（`jsj.top` 域名），会自动优化 URL 参数
4. 使用 `web-view` 组件嵌入表单

### URL 参数说明

金数据表单支持以下 URL 参数（已自动添加）：

- `banner=hide`：隐藏页眉，更适合小程序嵌入
- `background=white`：白色背景，确保在小程序中显示正常

更多参数说明请参考：[金数据开放平台文档](https://open.jinshuju.net/embedded/overview)

## 错误处理

如果表单无法加载，可能的原因：

1. **域名未配置**：`jsj.top` 未添加到小程序业务域名
2. **表单设置问题**：表单未发布或不允许嵌入
3. **网络问题**：网络连接不稳定

系统会自动提示用户，并提供复制链接到浏览器打开的选项。

## 技术实现

### 代码位置

- 问卷页面：`miniprogram/pages/questionnaire/index.js`
- 活动详情页：`miniprogram/pages/activity-detail/index.js`

### 关键功能

1. **自动检测金数据表单**：
```javascript
isJinshujuForm(url) {
  const urlObj = new URL(url);
  return urlObj.hostname === 'jsj.top' || urlObj.hostname.endsWith('.jsj.top');
}
```

2. **优化 URL 参数**：
```javascript
optimizeJinshujuUrl(url) {
  const urlObj = new URL(url);
  if (!urlObj.searchParams.has('banner')) {
    urlObj.searchParams.set('banner', 'hide');
  }
  if (!urlObj.searchParams.has('background')) {
    urlObj.searchParams.set('background', 'white');
  }
  return urlObj.toString();
}
```

## 测试步骤

1. 确保已配置业务域名 `jsj.top`
2. 在活动数据中添加金数据表单链接
3. 在活动详情页点击"立即报名"
4. 验证表单是否正常加载
5. 测试表单填写和提交功能

## 常见问题

### Q: 表单无法加载，提示域名未配置？

A: 需要在微信小程序后台配置业务域名 `jsj.top`，并上传验证文件。

### Q: 表单可以加载，但显示不正常？

A: 检查金数据表单是否开启了微信收集信息或微信支付，这些功能会导致嵌入失效。

### Q: 如何自定义表单显示效果？

A: 可以在 `optimizeJinshujuUrl` 方法中修改参数：
- `banner=show` 或 `banner=hide`：显示/隐藏页眉
- `background=white` 或 `background=transparent`：白色/透明背景

## 参考文档

- [金数据开放平台 - 表单嵌入](https://open.jinshuju.net/embedded/overview)
- [微信小程序 - web-view 组件](https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html)
- [微信小程序 - 业务域名配置](https://developers.weixin.qq.com/miniprogram/dev/framework/config.html#%E4%B8%9A%E5%8A%A1%E5%9F%9F%E5%90%8D)

